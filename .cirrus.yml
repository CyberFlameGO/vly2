container:
  image: node:12

lint_task:
  node_modules_cache:
    folder: node_modules
    fingerprint_script: cat package-lock.json
    populate_script: npm ci
  lint_script: npm run lint

test_task:
  env:
    # For some reason AVA/Cirrus get confused about not all tasks being test tasks, so we override the defaults to
    # force AVA to run all the tests in one task.
    CI_NODE_INDEX: 0
    CI_NODE_TOTAL: 1
  node_modules_cache:
    folder: node_modules
    fingerprint_script: cat package-lock.json
    populate_script: MONGOMS_DOWNLOAD_MIRROR="http://downloads.mongodb.org" MONGOMS_VERSION="4.0.5" MONGOMS_DISABLE_POSTINSTALL=1 npm ci
  test_script: npm test -- --tap --verbose --serial `find . -name '*.spec.js'`

prod_docker_docker_builder:
  only_if: $CIRRUS_BRANCH == 'master'
  depends_on:
    - test
    - lint
  env:
    AWS_ACCOUNT_ID: ENCRYPTED[3afae87e49cb7fb6d48c91aad7fdbca95b7bdad59a37ba5e5baa04f9be4bb7dc7b58dff4b44e754e438c21af6e414636]
    AWS_ACCESS_KEY_ID: ENCRYPTED[d86162b4131f8b01011d04f450b54011d70b5b613fc9a86b1e6f589ecf9e0864e4e4469fafbcee218eac16f799c2391d]
    AWS_SECRET_ACCESS_KEY: ENCRYPTED[74a41c950ca740c721e7be77eee13576159bceade6cbac8f179066a57edce4d9d43430df4b5af82d5d94b17b066895b3]
  prepare_script:
    - pip install awscli
    - export PATH=$PATH:$HOME/.local/bin
  build_script: docker build --target=production --tag voluntarily/vly2:${CIRRUS_BRANCH//\//-} .
  push_script:
    - $(aws ecr get-login --no-include-email --region ap-southeast-1)
    - docker tag voluntarily/vly2:${CIRRUS_BRANCH//\//-} ${AWS_ACCOUNT_ID}.dkr.ecr.ap-southeast-1.amazonaws.com/vly2-alpha:${CIRRUS_BRANCH//\//-}
    - docker push ${AWS_ACCOUNT_ID}.dkr.ecr.ap-southeast-1.amazonaws.com/vly2-alpha:${CIRRUS_BRANCH//\//-}
